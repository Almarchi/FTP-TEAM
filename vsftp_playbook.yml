---
- name: Configure Vagrant machine 'venus' with FTP setup
  hosts: venus
  become: yes
  tasks:
    - name: Update APT package cache
      apt:
        update_cache: yes

    - name: Install vsftpd package
      apt:
        name: vsftpd
        state: present

    # - name: Check if FTP user exists and verify home directory
    #   command: grep '^ftp:' /etc/passwd
    #   register: ftp_user
    #   changed_when: false

    # - name: Display FTP user information
    #   debug:
    #     msg: "{{ ftp_user.stdout }}"

    # - name: Check FTP group information
    #   command: grep '^ftp:' /etc/group
    #   register: ftp_group
    #   changed_when: false

    # - name: Display FTP group information
    #   debug:
    #     msg: "{{ ftp_group.stdout }}"

    # - name: Verify /srv/ftp directory and ownership
    #   stat:
    #     path: /srv/ftp
    #   register: ftp_directory

    # - name: Display /srv/ftp directory information
    #   debug:
    #     msg: "{{ ftp_directory.stat }}"

    # - name: List system users who cannot access FTP service
    #   command: cat /etc/ftpusers
    #   register: restricted_users
    #   changed_when: false

    # - name: Display restricted users
    #   debug:
    #     msg: "{{ restricted_users.stdout }}"

    - name: Check if vsftpd service is running
      service:
        name: vsftpd
        state: started
      register: vsftpd_status

    - name: Display vsftpd service status
      debug:
        msg: "Service 'vsftpd' is running: {{ vsftpd_status.state == 'started' }}"

    - name: Verify vsftpd is listening on port 21
      shell: "ss -tuln | grep ':21 '"
      register: ss_output
      failed_when: ss_output.rc != 0
      changed_when: false

    - name: Display port 21 listening status
      debug:
        msg: "{{ ss_output.stdout }}"

    - name: Backup vsftpd configuration file
      copy:
        remote_src: yes
        src: /etc/vsftpd.conf
        dest: /vagrant/vsftpd.conf.bak

    - name: Create configuration file for vsftpd
      copy:
        dest: /etc/vsftpd.conf
        content: |
          # 1. El servidor se inicia en modo standalone usando IPv4.
          listen=YES
          listen_ipv6=NO

          # 2. Mensaje de bienvenida que presentará el servidor al conectarse los clientes.
          ftpd_banner=Welcome to the FTP server of 'sistema.sol'

          # 3. Mensaje para usuarios anónimos al acceder.
          dirmessage_enable=YES
          message_file=/srv/ftp/.message

          # 4. Habilitar el puerto 20 para la conexión de datos.
          connect_from_port_20=YES

          # 5. Cerrar conexiones inactivas después de 720 segundos.
          idle_session_timeout=720

          # 6. Permitir un máximo de 15 conexiones simultáneas al servidor.
          max_clients=15

          # 7. Limitar el ancho de banda de los usuarios con cuenta a 5 MB/s.
          local_max_rate=5120

          # 8. Limitar el ancho de banda de los usuarios anónimos a 2 MB/s.
          anon_max_rate=2048

          # 9. Permitir acceso a usuarios anónimos con solo permisos de lectura.
          anonymous_enable=YES
          anon_upload_enable=NO
          anon_mkdir_write_enable=NO

          # 10. Permitir acceso a usuarios locales con permisos de lectura y escritura.
          local_enable=YES
          write_enable=YES

          # 11. Enjaular a todos los usuarios locales excepto a Maria en su directorio home.
          chroot_local_user=YES
          chroot_list_enable=YES
          chroot_list_file=/etc/vsftpd.chroot_list

    - name: Create directory for anonymous FTP messages
      file:
        path: /srv/ftp/.message
        state: touch

    - name: Set anonymous FTP message
      copy:
        content: |
          ---You have accessed the public directory server of 'sistema.sol'---
        dest: /srv/ftp/.message

    - name: Configure chroot list for vsftpd
      copy:
        dest: /etc/vsftpd.chroot_list
        content: |
          maria

    - name: Restart vsftpd service
      service:
        name: vsftpd
        state: restarted

    - name: Create local users
      user:
        name: "{{ item }}"
        state: present
        shell: /bin/bash
      loop:
        - luis
        - maria
        - miguel

    - name: Create text files in Luis's home directory
      file:
        path: "/home/luis/{{ item }}"
        state: touch
      loop:
        - luis1.txt
        - luis2.txt

    - name: Create text files in Maria's home directory
      file:
        path: "/home/maria/{{ item }}"
        state: touch
      loop:
        - maria1.txt
        - maria2.txt
